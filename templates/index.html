<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Analysis Web App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>Sentiment Analysis</h1>
            <button id="darkModeToggle" title="Toggle dark mode">üåô</button>
        </div>
        <form method="POST" action="/" enctype="multipart/form-data" class="input-form">
            <textarea name="user_text" placeholder="Enter your review here..." required>{{ request.form.user_text or '' }}</textarea>
            <div class="form-row">
                <button type="submit">Analyze</button>
                <label class="csv-upload">
                    <input type="file" name="csv_file" accept=".csv" onchange="this.form.submit()" hidden>
                    <span>üìÅ Upload CSV</span>
                </label>
                <a href="/download" class="download-btn">‚¨áÔ∏è Download CSV</a>
                <a href="/reset" class="reset-btn">Reset</a>
            </div>
        </form>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        {% if result and not result.get('batch') %}
        <div class="result {{ result.sentiment|lower }}">
            <span class="sentiment-emoji">{{ result.emoji }}</span>
            <strong>{{ result.sentiment }}</strong>
            <span class="confidence">Confidence: {{ result.confidence }}%</span><br>
            <span class="user-text">"{{ result.text }}"</span>
        </div>
        {% elif result and result.get('batch') %}
        <div class="result neutral">
            <span>Batch processed: <b>{{ result.count }}</b> reviews analyzed.</span>
        </div>
        {% endif %}

        <div class="chart-section">
            <h2>Sentiment Distribution</h2>
            <div class="charts-flex">
                <div>
                    <canvas id="sentimentBarChart" width="320" height="180"></canvas>
                </div>
                <div>
                    <canvas id="sentimentPieChart" width="180" height="180"></canvas>
                </div>
            </div>
        </div>

        <div class="wordcloud-section">
            <h2>Word Cloud (All Reviews)</h2>
            {% if wordcloud_b64 %}
            <img src="data:image/png;base64,{{ wordcloud_b64 }}" alt="Word Cloud" class="wordcloud-img">
            {% else %}
            <div class="no-wordcloud">No data yet.</div>
            {% endif %}
            <div class="wordcloud-flex">
                <div>
                    <h3>Positive Words</h3>
                    {% if wordcloud_pos_b64 %}
                    <img src="data:image/png;base64,{{ wordcloud_pos_b64 }}" alt="Positive Word Cloud" class="wordcloud-img">
                    {% else %}<div class="no-wordcloud">No data.</div>{% endif %}
                </div>
                <div>
                    <h3>Negative Words</h3>
                    {% if wordcloud_neg_b64 %}
                    <img src="data:image/png;base64,{{ wordcloud_neg_b64 }}" alt="Negative Word Cloud" class="wordcloud-img">
                    {% else %}<div class="no-wordcloud">No data.</div>{% endif %}
                </div>
            </div>
        </div>

        <div class="results-table-section">
            <h2>All Results (Session)</h2>
            {% if results %}
            <table class="results-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Text</th>
                        <th>Sentiment</th>
                        <th>Confidence</th>
                        <th>Emoji</th>
                    </tr>
                </thead>
                <tbody>
                {% for r in results %}
                    <tr class="{{ r.sentiment|lower }}">
                        <td>{{ loop.index }}</td>
                        <td>{{ r.text }}</td>
                        <td>{{ r.sentiment }}</td>
                        <td>{{ r.confidence }}%</td>
                        <td>{{ r.emoji }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}<div class="no-results">No results yet.</div>{% endif %}
        </div>
    </div>

    <!-- Chart Data -->
    <script id="bar-data" type="application/json">{{ bar_data|tojson }}</script>
    <script id="pie-data" type="application/json">{{ pie_data|tojson }}</script>

    <script>
    // Bar Chart
    const barData = JSON.parse(document.getElementById('bar-data').textContent);
    const barCtx = document.getElementById('sentimentBarChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
                label: 'Count',
                data: barData,
                backgroundColor: [
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(149, 165, 166, 0.7)'
                ],
                borderColor: [
                    'rgba(39, 174, 96, 1)',
                    'rgba(192, 57, 43, 1)',
                    'rgba(127, 140, 141, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    // Pie Chart
    const pieData = JSON.parse(document.getElementById('pie-data').textContent);
    const pieCtx = document.getElementById('sentimentPieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
                data: pieData,
                backgroundColor: [
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(149, 165, 166, 0.7)'
                ],
                borderColor: [
                    'rgba(39, 174, 96, 1)',
                    'rgba(192, 57, 43, 1)',
                    'rgba(127, 140, 141, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Dark mode toggle
    const darkModeBtn = document.getElementById('darkModeToggle');
    darkModeBtn.onclick = function() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    };
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
    </script>
</body>
</html>
